// =============================================================================
// Diyafa Catering SaaS Platform — Prisma Schema
// =============================================================================
// Purpose: Multi-tenant catering platform for Morocco/MENA market
// Stack:   Next.js 14 + tRPC + Prisma + Supabase
// Base:    Evolved from restaurant menu system foundation
// =============================================================================

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["multiSchema"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
  schemas   = ["auth", "public"]
}

// =============================================================================
// AUTH SCHEMA — Supabase Auth (managed, do not modify)
// =============================================================================

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model AuditLogEntries {
  instanceId String?   @map("instance_id") @db.Uuid
  id         String    @id @db.Uuid
  payload    Json?     @db.Json
  createdAt  DateTime? @map("created_at") @db.Timestamptz(6)
  ipAddress  String    @default("") @map("ip_address") @db.VarChar(64)

  @@index([instanceId], map: "audit_logs_instance_id_idx")
  @@map("audit_log_entries")
  @@schema("auth")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model FlowState {
  id                   String               @id @db.Uuid
  userId               String?              @map("user_id") @db.Uuid
  authCode             String?              @map("auth_code")
  codeChallengeMethod  CodeChallengeMethod? @map("code_challenge_method")
  codeChallenge        String?              @map("code_challenge")
  providerType         String               @map("provider_type")
  providerAccessToken  String?              @map("provider_access_token")
  providerRefreshToken String?              @map("provider_refresh_token")
  createdAt            DateTime?            @map("created_at") @db.Timestamptz(6)
  updatedAt            DateTime?            @map("updated_at") @db.Timestamptz(6)
  authenticationMethod String               @map("authentication_method")
  authCodeIssuedAt     DateTime?            @map("auth_code_issued_at") @db.Timestamptz(6)
  inviteToken          String?              @map("invite_token")
  referrer             String?
  oauthClientStateId   String?              @map("oauth_client_state_id") @db.Uuid
  linkingTargetId      String?              @map("linking_target_id") @db.Uuid
  emailOptional        Boolean              @default(false) @map("email_optional")
  samlRelayStates      SamlRelayStates[]

  @@index([authCode], map: "idx_auth_code")
  @@index([userId, authenticationMethod], map: "idx_user_id_auth_method")
  @@index([createdAt(sort: Desc)])
  @@map("flow_state")
  @@schema("auth")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model Identities {
  providerId   String    @map("provider_id")
  userId       String    @map("user_id") @db.Uuid
  identityData Json      @map("identity_data")
  provider     String
  lastSignInAt DateTime? @map("last_sign_in_at") @db.Timestamptz(6)
  createdAt    DateTime? @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime? @map("updated_at") @db.Timestamptz(6)
  email        String?   @default(dbgenerated("lower((identity_data ->> 'email'::text))"))
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  users        Users     @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([providerId, provider], map: "identities_provider_id_provider_unique")
  @@index([email])
  @@index([userId])
  @@map("identities")
  @@schema("auth")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model Instances {
  id            String    @id @db.Uuid
  uuid          String?   @db.Uuid
  rawBaseConfig String?   @map("raw_base_config")
  createdAt     DateTime? @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime? @map("updated_at") @db.Timestamptz(6)

  @@map("instances")
  @@schema("auth")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model MfaAmrClaims {
  sessionId            String   @map("session_id") @db.Uuid
  createdAt            DateTime @map("created_at") @db.Timestamptz(6)
  updatedAt            DateTime @map("updated_at") @db.Timestamptz(6)
  authenticationMethod String   @map("authentication_method")
  id                   String   @id(map: "amr_id_pk") @db.Uuid
  sessions             Sessions @relation(fields: [sessionId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([sessionId, authenticationMethod], map: "mfa_amr_claims_session_id_authentication_method_pkey")
  @@map("mfa_amr_claims")
  @@schema("auth")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model MfaChallenges {
  id                  String     @id @db.Uuid
  factorId            String     @map("factor_id") @db.Uuid
  createdAt           DateTime   @map("created_at") @db.Timestamptz(6)
  verifiedAt          DateTime?  @map("verified_at") @db.Timestamptz(6)
  ipAddress           String     @map("ip_address") @db.Inet
  otpCode             String?    @map("otp_code")
  webAuthnSessionData Json?      @map("web_authn_session_data")
  mfaFactors          MfaFactors @relation(fields: [factorId], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "mfa_challenges_auth_factor_id_fkey")

  @@index([createdAt(sort: Desc)], map: "mfa_challenge_created_at_idx")
  @@map("mfa_challenges")
  @@schema("auth")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model MfaFactors {
  id                        String          @id @db.Uuid
  userId                    String          @map("user_id") @db.Uuid
  friendlyName              String?         @map("friendly_name")
  factorType                FactorType      @map("factor_type")
  status                    FactorStatus    @map("status")
  createdAt                 DateTime        @map("created_at") @db.Timestamptz(6)
  updatedAt                 DateTime        @map("updated_at") @db.Timestamptz(6)
  secret                    String?
  phone                     String?
  lastChallengedAt          DateTime?       @unique @map("last_challenged_at") @db.Timestamptz(6)
  webAuthnCredential        Json?           @map("web_authn_credential")
  webAuthnAaguid            String?         @map("web_authn_aaguid") @db.Uuid
  lastWebauthnChallengeData Json?           @map("last_webauthn_challenge_data")
  mfaChallenges             MfaChallenges[]
  users                     Users           @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([userId, phone], map: "unique_phone_factor_per_user")
  @@index([userId, createdAt], map: "factor_id_created_at_idx")
  @@index([userId])
  @@map("mfa_factors")
  @@schema("auth")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model RefreshTokens {
  instanceId String?   @map("instance_id") @db.Uuid
  id         BigInt    @id @default(autoincrement())
  token      String?   @unique(map: "refresh_tokens_token_unique") @db.VarChar(255)
  userId     String?   @map("user_id") @db.VarChar(255)
  revoked    Boolean?
  createdAt  DateTime? @map("created_at") @db.Timestamptz(6)
  updatedAt  DateTime? @map("updated_at") @db.Timestamptz(6)
  parent     String?   @db.VarChar(255)
  sessionId  String?   @map("session_id") @db.Uuid
  sessions   Sessions? @relation(fields: [sessionId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([instanceId])
  @@index([instanceId, userId])
  @@index([parent])
  @@index([sessionId, revoked])
  @@index([updatedAt(sort: Desc)])
  @@map("refresh_tokens")
  @@schema("auth")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model SamlProviders {
  id               String       @id @db.Uuid
  ssoProviderId    String       @map("sso_provider_id") @db.Uuid
  entityId         String       @unique @map("entity_id")
  metadataXml      String       @map("metadata_xml")
  metadataUrl      String?      @map("metadata_url")
  attributeMapping Json?        @map("attribute_mapping")
  createdAt        DateTime?    @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime?    @map("updated_at") @db.Timestamptz(6)
  nameIdFormat     String?      @map("name_id_format")
  ssoProviders     SsoProviders @relation(fields: [ssoProviderId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([ssoProviderId])
  @@map("saml_providers")
  @@schema("auth")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model SamlRelayStates {
  id            String       @id @db.Uuid
  ssoProviderId String       @map("sso_provider_id") @db.Uuid
  requestId     String       @map("request_id")
  forEmail      String?      @map("for_email")
  redirectTo    String?      @map("redirect_to")
  createdAt     DateTime?    @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime?    @map("updated_at") @db.Timestamptz(6)
  flowStateId   String?      @map("flow_state_id") @db.Uuid
  flowState     FlowState?   @relation(fields: [flowStateId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  ssoProviders  SsoProviders @relation(fields: [ssoProviderId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([forEmail])
  @@index([ssoProviderId])
  @@index([createdAt(sort: Desc)])
  @@map("saml_relay_states")
  @@schema("auth")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model SchemaMigrations {
  version String @id @db.VarChar(255)

  @@map("schema_migrations")
  @@schema("auth")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model Sessions {
  id                  String          @id @db.Uuid
  userId              String          @map("user_id") @db.Uuid
  createdAt           DateTime?       @map("created_at") @db.Timestamptz(6)
  updatedAt           DateTime?       @map("updated_at") @db.Timestamptz(6)
  factorId            String?         @map("factor_id") @db.Uuid
  aal                 AalLevel?       @map("aal")
  notAfter            DateTime?       @map("not_after") @db.Timestamptz(6)
  refreshedAt         DateTime?       @map("refreshed_at") @db.Timestamp(6)
  userAgent           String?         @map("user_agent")
  ip                  String?         @db.Inet
  tag                 String?
  oauthClientId       String?         @map("oauth_client_id") @db.Uuid
  refreshTokenHmacKey String?         @map("refresh_token_hmac_key")
  refreshTokenCounter BigInt?         @map("refresh_token_counter")
  scopes              String?
  mfaAmrClaims        MfaAmrClaims[]
  refreshTokens       RefreshTokens[]
  oauthClients        OauthClients?   @relation(fields: [oauthClientId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  users               Users           @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([userId])
  @@index([userId, createdAt], map: "user_id_created_at_idx")
  @@index([notAfter(sort: Desc)])
  @@index([oauthClientId])
  @@map("sessions")
  @@schema("auth")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
/// This model contains an expression index which requires additional setup for migrations. Visit https://pris.ly/d/expression-indexes for more info.
model SsoDomains {
  id            String       @id @db.Uuid
  ssoProviderId String       @map("sso_provider_id") @db.Uuid
  domain        String
  createdAt     DateTime?    @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime?    @map("updated_at") @db.Timestamptz(6)
  ssoProviders  SsoProviders @relation(fields: [ssoProviderId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([ssoProviderId])
  @@map("sso_domains")
  @@schema("auth")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
/// This model contains an expression index which requires additional setup for migrations. Visit https://pris.ly/d/expression-indexes for more info.
model SsoProviders {
  id              String            @id @db.Uuid
  resourceId      String?           @map("resource_id")
  createdAt       DateTime?         @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime?         @map("updated_at") @db.Timestamptz(6)
  disabled        Boolean?
  samlProviders   SamlProviders[]
  samlRelayStates SamlRelayStates[]
  ssoDomains      SsoDomains[]

  @@index([resourceId], map: "sso_providers_resource_id_pattern_idx")
  @@map("sso_providers")
  @@schema("auth")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
/// This model contains an expression index which requires additional setup for migrations. Visit https://pris.ly/d/expression-indexes for more info.
model Users {
  instanceId               String?               @map("instance_id") @db.Uuid
  id                       String                @id @db.Uuid
  aud                      String?               @db.VarChar(255)
  role                     String?               @db.VarChar(255)
  email                    String?               @db.VarChar(255)
  encryptedPassword        String?               @map("encrypted_password") @db.VarChar(255)
  emailConfirmedAt         DateTime?             @map("email_confirmed_at") @db.Timestamptz(6)
  invitedAt                DateTime?             @map("invited_at") @db.Timestamptz(6)
  confirmationToken        String?               @map("confirmation_token") @db.VarChar(255)
  confirmationSentAt       DateTime?             @map("confirmation_sent_at") @db.Timestamptz(6)
  recoveryToken            String?               @map("recovery_token") @db.VarChar(255)
  recoverySentAt           DateTime?             @map("recovery_sent_at") @db.Timestamptz(6)
  emailChangeTokenNew      String?               @map("email_change_token_new") @db.VarChar(255)
  emailChange              String?               @map("email_change") @db.VarChar(255)
  emailChangeSentAt        DateTime?             @map("email_change_sent_at") @db.Timestamptz(6)
  lastSignInAt             DateTime?             @map("last_sign_in_at") @db.Timestamptz(6)
  rawAppMetaData           Json?                 @map("raw_app_meta_data")
  rawUserMetaData          Json?                 @map("raw_user_meta_data")
  isSuperAdmin             Boolean?              @map("is_super_admin")
  createdAt                DateTime?             @map("created_at") @db.Timestamptz(6)
  updatedAt                DateTime?             @map("updated_at") @db.Timestamptz(6)
  phone                    String?               @unique
  phoneConfirmedAt         DateTime?             @map("phone_confirmed_at") @db.Timestamptz(6)
  phoneChange              String?               @default("") @map("phone_change")
  phoneChangeToken         String?               @default("") @map("phone_change_token") @db.VarChar(255)
  phoneChangeSentAt        DateTime?             @map("phone_change_sent_at") @db.Timestamptz(6)
  confirmedAt              DateTime?             @default(dbgenerated("LEAST(email_confirmed_at, phone_confirmed_at)")) @map("confirmed_at") @db.Timestamptz(6)
  emailChangeTokenCurrent  String?               @default("") @map("email_change_token_current") @db.VarChar(255)
  emailChangeConfirmStatus Int?                  @default(0) @map("email_change_confirm_status") @db.SmallInt
  bannedUntil              DateTime?             @map("banned_until") @db.Timestamptz(6)
  reauthenticationToken    String?               @default("") @map("reauthentication_token") @db.VarChar(255)
  reauthenticationSentAt   DateTime?             @map("reauthentication_sent_at") @db.Timestamptz(6)
  isSsoUser                Boolean               @default(false) @map("is_sso_user")
  deletedAt                DateTime?             @map("deleted_at") @db.Timestamptz(6)
  isAnonymous              Boolean               @default(false) @map("is_anonymous")
  identities               Identities[]
  mfaFactors               MfaFactors[]
  oauthAuthorizations      OauthAuthorizations[]
  oauthConsents            OauthConsents[]
  oneTimeTokens            OneTimeTokens[]
  sessions                 Sessions[]
  // Public schema relations
  profiles                 Profiles?
  orgMembers               OrgMembers[]
  clientProfiles           ClientProfiles?

  @@index([instanceId])
  @@index([isAnonymous])
  @@map("users")
  @@schema("auth")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model OauthAuthorizations {
  id                  String                   @id @db.Uuid
  authorizationId     String                   @unique @map("authorization_id")
  clientId            String                   @map("client_id") @db.Uuid
  userId              String?                  @map("user_id") @db.Uuid
  redirectUri         String                   @map("redirect_uri")
  scope               String
  state               String?
  resource            String?
  codeChallenge       String?                  @map("code_challenge")
  codeChallengeMethod CodeChallengeMethod?     @map("code_challenge_method")
  responseType        OauthResponseType        @default(code) @map("response_type")
  status              OauthAuthorizationStatus @default(pending) @map("status")
  authorizationCode   String?                  @unique @map("authorization_code")
  createdAt           DateTime                 @default(now()) @map("created_at") @db.Timestamptz(6)
  expiresAt           DateTime                 @default(dbgenerated("(now() + '00:03:00'::interval)")) @map("expires_at") @db.Timestamptz(6)
  approvedAt          DateTime?                @map("approved_at") @db.Timestamptz(6)
  nonce               String?
  oauthClients        OauthClients             @relation(fields: [clientId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  users               Users?                   @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@map("oauth_authorizations")
  @@schema("auth")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model OauthClientStates {
  id           String   @id @db.Uuid
  providerType String   @map("provider_type")
  codeVerifier String?  @map("code_verifier")
  createdAt    DateTime @map("created_at") @db.Timestamptz(6)

  @@index([createdAt], map: "idx_oauth_client_states_created_at")
  @@map("oauth_client_states")
  @@schema("auth")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model OauthClients {
  id                      String                @id @db.Uuid
  clientSecretHash        String?               @map("client_secret_hash")
  registrationType        OauthRegistrationType @map("registration_type")
  redirectUris            String                @map("redirect_uris")
  grantTypes              String                @map("grant_types")
  clientName              String?               @map("client_name")
  clientUri               String?               @map("client_uri")
  logoUri                 String?               @map("logo_uri")
  createdAt               DateTime              @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt               DateTime              @default(now()) @map("updated_at") @db.Timestamptz(6)
  deletedAt               DateTime?             @map("deleted_at") @db.Timestamptz(6)
  clientType              OauthClientType       @default(confidential) @map("client_type")
  tokenEndpointAuthMethod String                @map("token_endpoint_auth_method")
  oauthAuthorizations     OauthAuthorizations[]
  oauthConsents           OauthConsents[]
  sessions                Sessions[]

  @@index([deletedAt])
  @@map("oauth_clients")
  @@schema("auth")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model OauthConsents {
  id           String       @id @db.Uuid
  userId       String       @map("user_id") @db.Uuid
  clientId     String       @map("client_id") @db.Uuid
  scopes       String
  grantedAt    DateTime     @default(now()) @map("granted_at") @db.Timestamptz(6)
  revokedAt    DateTime?    @map("revoked_at") @db.Timestamptz(6)
  oauthClients OauthClients @relation(fields: [clientId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  users        Users        @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([userId, clientId], map: "oauth_consents_user_client_unique")
  @@index([userId, grantedAt(sort: Desc)], map: "oauth_consents_user_order_idx")
  @@map("oauth_consents")
  @@schema("auth")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model OneTimeTokens {
  id        String           @id @db.Uuid
  userId    String           @map("user_id") @db.Uuid
  tokenType OneTimeTokenType @map("token_type")
  tokenHash String           @map("token_hash")
  relatesTo String           @map("relates_to")
  createdAt DateTime         @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt DateTime         @default(now()) @map("updated_at") @db.Timestamp(6)
  users     Users            @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([userId, tokenType])
  @@index([relatesTo], map: "one_time_tokens_relates_to_hash_idx", type: Hash)
  @@index([tokenHash], map: "one_time_tokens_token_hash_hash_idx", type: Hash)
  @@map("one_time_tokens")
  @@schema("auth")
}

// =============================================================================
// PUBLIC SCHEMA — Application Data
// =============================================================================

// =============================================================================
// SECTION 1: User Profiles & Authentication
// =============================================================================

/// User profiles linked to Supabase auth.users.
/// Every authenticated user has one profile (caterer, client, or platform admin).
model Profiles {
  id              String         @id @db.Uuid
  updatedAt       DateTime?      @map("updated_at") @db.Timestamptz(6)
  username        String?        @unique
  fullName        String?        @map("full_name")
  email           String         @unique
  aiProvider      String?        @default("openai") @map("ai_provider")
  aiModel         String?        @default("gpt-4o-mini") @map("ai_model")
  role            UserRole       @default(user)
  users           Users          @relation(fields: [id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  // Relations
  aiUsage         AiUsage[]
  appAuditLog     AppAuditLog[]
  subscriptions   Subscriptions?

  @@index([role], map: "idx_profiles_role")
  @@map("profiles")
  @@schema("public")
}

/// AI usage tracking per user for billing and rate limiting
model AiUsage {
  id         String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId     String   @map("user_id") @db.Uuid
  provider   String
  model      String
  feature    String
  tokensUsed Int      @default(0) @map("tokens_used")
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  profiles   Profiles @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([userId, createdAt(sort: Desc)], map: "idx_ai_usage_user_created")
  @@index([createdAt], map: "idx_ai_usage_created_at")
  @@index([userId], map: "idx_ai_usage_user_id")
  @@map("ai_usage")
  @@schema("public")
}

/// Subscription management (LemonSqueezy integration, bypassed in dev)
model Subscriptions {
  profileId        String    @id @map("profile_id") @db.Uuid
  updatePaymentUrl String    @map("update_payment_url")
  renewsAt         DateTime  @map("renews_at") @db.Timestamptz(6)
  endsAt           DateTime? @map("ends_at") @db.Timestamptz(6)
  status           String
  createdAt        DateTime? @map("created_at") @db.Timestamptz(6)
  lemonSqueezyId   String    @map("lemon_squeezy_id")
  jsonData         Json      @map("json_data")
  profiles         Profiles  @relation(fields: [profileId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([status], map: "idx_subscriptions_status")
  @@map("subscriptions")
  @@schema("public")
}

/// Application-level audit log for security tracking
model AppAuditLog {
  id         String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId     String?   @map("user_id") @db.Uuid
  action     String
  entityType String    @map("entity_type")
  entityId   String?   @map("entity_id") @db.Uuid
  oldData    Json?     @map("old_data")
  newData    Json?     @map("new_data")
  ipAddress  String?   @map("ip_address")
  userAgent  String?   @map("user_agent")
  createdAt  DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  user       Profiles? @relation(fields: [userId], references: [id], onUpdate: NoAction)

  @@index([userId], map: "idx_audit_log_user_id")
  @@index([entityType, entityId], map: "idx_audit_log_entity")
  @@index([createdAt], map: "idx_audit_log_created_at")
  @@index([action], map: "idx_audit_log_action")
  @@index([entityType, action], map: "idx_audit_log_entity_action")
  @@map("app_audit_log")
  @@schema("public")
}

// =============================================================================
// SECTION 2: Organizations (Multi-Tenant Core)
// =============================================================================

/// The central multi-tenant entity. Every caterer/restaurant/hotel/venue is an Organization.
/// ALL business data is scoped to an org via org_id foreign keys.
/// RLS policies enforce that users only see data for orgs they belong to.
model Organizations {
  id                String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  name              String   @db.VarChar(200)
  slug              String   @unique @db.VarChar(300)
  type              OrgType  @default(caterer)
  description       String?
  bio               String?
  tagline           String?  @db.VarChar(300)

  // Location
  city              String?  @db.VarChar(100)
  address           String?
  latitude          Decimal? @db.Decimal(10, 7)
  longitude         Decimal? @db.Decimal(10, 7)
  serviceAreas      String[] @default([]) @map("service_areas")

  // Contact
  phone             String?  @db.VarChar(30)
  email             String?  @db.VarChar(200)
  whatsappNumber    String?  @map("whatsapp_number") @db.VarChar(30)
  website           String?  @db.VarChar(500)
  instagram         String?  @db.VarChar(100)
  facebook          String?  @db.VarChar(100)

  // Business details
  cuisines          String[] @default([])
  specialties       String[] @default([])
  eventTypes        String[] @default([]) @map("event_types")
  serviceStyles     String[] @default([]) @map("service_styles")
  languages         String[] @default(["ar", "fr"])
  minGuests         Int?     @default(10) @map("min_guests")
  maxGuests         Int?     @default(500) @map("max_guests")
  priceRange        PriceRange? @default(mid) @map("price_range")
  yearsInBusiness   Int?     @map("years_in_business")
  teamSize          Int?     @map("team_size")
  priceMin          Int?     @map("price_min")
  priceMax          Int?     @map("price_max")

  // Branding
  logoUrl           String?  @map("logo_url")
  coverImageUrl     String?  @map("cover_image_url")

  // Verification (Morocco: Patente, RC, ICE)
  isVerified        Boolean  @default(false) @map("is_verified")
  verifiedAt        DateTime? @map("verified_at") @db.Timestamptz(6)
  registreCommerce  String?  @map("registre_commerce") @db.VarChar(50)
  identifiantFiscal String?  @map("identifiant_fiscal") @db.VarChar(50)

  // Stats (denormalized for fast reads)
  rating            Decimal? @default(0) @db.Decimal(3, 2)
  reviewCount       Int      @default(0) @map("review_count")
  totalEventsCompleted Int   @default(0) @map("total_events_completed")
  avgResponseTimeMin Int?    @map("avg_response_time_min")
  bookingRate       Decimal? @default(0) @map("booking_rate") @db.Decimal(5, 2)

  // Platform
  isActive          Boolean  @default(true) @map("is_active")
  isPublished       Boolean  @default(false) @map("is_published")
  isFeatured        Boolean  @default(false) @map("is_featured")
  subscriptionTier  SubscriptionTier @default(free) @map("subscription_tier")
  settings          Json?    @default("{}")

  // Settings
  defaultPaymentTemplate String?  @default("standard") @map("default_payment_template") @db.VarChar(50)
  defaultLeadTimeDays    Int      @default(7) @map("default_lead_time_days")
  autoReplyEnabled       Boolean  @default(false) @map("auto_reply_enabled")
  autoReplyMessage       String?  @map("auto_reply_message")
  currency               String   @default("MAD") @db.VarChar(10)

  // SEO
  metaTitle         String?  @map("meta_title") @db.VarChar(200)
  metaDescription   String?  @map("meta_description") @db.VarChar(500)

  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime @default(now()) @map("updated_at") @db.Timestamptz(6)

  // Relations
  members           OrgMembers[]
  portfolio         PortfolioImages[]
  cateringMenus     CateringMenus[]
  events            Events[]
  quotes            Quotes[]
  paymentSchedules  PaymentSchedules[]
  equipment         Equipment[]
  cateringStaff     CateringStaff[]
  conversations     Conversations[]
  reviews           Reviews[]
  invoices          Invoices[]
  blockedDates      BlockedDates[]
  analyticsEvents   AnalyticsEvents[]
  orgTheme          OrgThemes?

  @@index([slug], map: "idx_organizations_slug")
  @@index([city], map: "idx_organizations_city")
  @@index([type], map: "idx_organizations_type")
  @@index([isPublished, isActive], map: "idx_organizations_published_active")
  @@index([rating(sort: Desc)], map: "idx_organizations_rating")
  @@index([isFeatured], map: "idx_organizations_featured")
  @@index([subscriptionTier], map: "idx_organizations_tier")
  @@index([cuisines], map: "idx_organizations_cuisines", type: Gin)
  @@index([eventTypes], map: "idx_organizations_event_types", type: Gin)
  @@index([serviceAreas], map: "idx_organizations_service_areas", type: Gin)
  @@index([name(ops: raw("gin_trgm_ops"))], map: "idx_organizations_name_trgm", type: Gin)
  @@map("organizations")
  @@schema("public")
}

/// Organization membership with role-based access control.
/// A user can belong to multiple orgs (e.g., manages two catering businesses).
/// Permissions JSON allows fine-grained control beyond the role hierarchy.
model OrgMembers {
  id           String        @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  orgId        String        @map("org_id") @db.Uuid
  userId       String        @map("user_id") @db.Uuid
  role         OrgRole       @default(staff)
  permissions  Json?         @default("{}")
  isActive     Boolean       @default(true) @map("is_active")
  invitedBy    String?       @map("invited_by") @db.Uuid
  invitedAt    DateTime?     @map("invited_at") @db.Timestamptz(6)
  acceptedAt   DateTime?     @map("accepted_at") @db.Timestamptz(6)
  createdAt    DateTime      @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime      @default(now()) @map("updated_at") @db.Timestamptz(6)

  org          Organizations @relation(fields: [orgId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  user         Users         @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  // Staff assignments for events
  staffAssignments StaffAssignments[]

  @@unique([orgId, userId])
  @@index([orgId], map: "idx_org_members_org_id")
  @@index([userId], map: "idx_org_members_user_id")
  @@index([orgId, role], map: "idx_org_members_org_role")
  @@index([orgId, isActive], map: "idx_org_members_org_active")
  @@map("org_members")
  @@schema("public")
}

/// Portfolio gallery images for organization showcase pages
model PortfolioImages {
  id         String        @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  orgId      String        @map("org_id") @db.Uuid
  imageUrl   String        @map("image_url")
  thumbnailUrl String?     @map("thumbnail_url")
  caption    String?       @db.VarChar(500)
  eventType  String?       @map("event_type") @db.VarChar(50)
  eventDate  DateTime?     @map("event_date") @db.Date
  isFeatured Boolean       @default(false) @map("is_featured")
  sortOrder  Int           @default(0) @map("sort_order")
  createdAt  DateTime      @default(now()) @map("created_at") @db.Timestamptz(6)
  org        Organizations @relation(fields: [orgId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([orgId], map: "idx_portfolio_images_org_id")
  @@index([orgId, isFeatured], map: "idx_portfolio_images_featured")
  @@map("portfolio_images")
  @@schema("public")
}

/// Organization-level theme/branding for public profile pages
model OrgThemes {
  id              String        @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  orgId           String        @unique @map("org_id") @db.Uuid
  primaryColor    String        @default("#B8860B") @map("primary_color") @db.VarChar(7)
  secondaryColor  String        @default("#8B6914") @map("secondary_color") @db.VarChar(7)
  backgroundColor String        @default("#FFFDF7") @map("background_color") @db.VarChar(7)
  surfaceColor    String        @default("#FFFFFF") @map("surface_color") @db.VarChar(7)
  textColor       String        @default("#1A1A1A") @map("text_color") @db.VarChar(7)
  accentColor     String        @default("#C2703E") @map("accent_color") @db.VarChar(7)
  headingFont     String        @default("Cormorant") @map("heading_font") @db.VarChar(100)
  bodyFont        String        @default("EB Garamond") @map("body_font") @db.VarChar(100)
  layoutStyle     String        @default("elegant") @map("layout_style") @db.VarChar(30)
  cardStyle       String        @default("elevated") @map("card_style") @db.VarChar(30)
  borderRadius    String        @default("medium") @map("border_radius") @db.VarChar(30)
  headerStyle     String        @default("banner") @map("header_style") @db.VarChar(30)
  customCss       String?       @default("") @map("custom_css")
  createdAt       DateTime      @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime      @default(now()) @map("updated_at") @db.Timestamptz(6)
  org             Organizations @relation(fields: [orgId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([orgId], map: "idx_org_themes_org_id")
  @@map("org_themes")
  @@schema("public")
}

// =============================================================================
// SECTION 3: Client Profiles (Marketplace Customers)
// =============================================================================

/// Client profiles for customers who book catering services.
/// Linked to auth.users for authenticated clients; phone-based for anonymous inquiries.
model ClientProfiles {
  id                String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId            String?  @unique @map("user_id") @db.Uuid
  name              String   @db.VarChar(200)
  phone             String?  @db.VarChar(30)
  email             String?  @db.VarChar(200)
  whatsapp          String?  @db.VarChar(30)
  city              String?  @db.VarChar(100)
  preferredLanguage String   @default("fr") @map("preferred_language") @db.VarChar(10)
  totalEventsBooked Int      @default(0) @map("total_events_booked")
  notes             String?
  tags              String[] @default([])
  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime @default(now()) @map("updated_at") @db.Timestamptz(6)
  user              Users?   @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  // Relations
  events            Events[]

  @@index([userId], map: "idx_client_profiles_user_id")
  @@index([phone], map: "idx_client_profiles_phone")
  @@index([email], map: "idx_client_profiles_email")
  @@map("client_profiles")
  @@schema("public")
}

// =============================================================================
// SECTION 4: Catering Menus, Categories, Items, Packages
// =============================================================================

/// Top-level catering menu owned by an organization.
/// A caterer can have multiple menus (e.g., "Wedding Menu", "Corporate Lunch", "Iftar Specials").
model CateringMenus {
  id                 String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  orgId              String   @map("org_id") @db.Uuid
  name               String   @db.VarChar(200)
  slug               String   @unique @db.VarChar(300)
  description        String?
  menuType           MenuType @default(per_head) @map("menu_type")
  eventType          String   @default("general") @map("event_type") @db.VarChar(50)
  minGuests          Int      @default(10) @map("min_guests")
  maxGuests          Int?     @map("max_guests")
  basePricePerPerson Int      @default(0) @map("base_price_per_person")
  currency           String   @default("MAD") @db.VarChar(10)
  leadTimeDays       Int      @default(3) @map("lead_time_days")
  dietaryTags        String[] @default([]) @map("dietary_tags")
  cuisineType        String?  @map("cuisine_type") @db.VarChar(50)
  photos             String[] @default([])

  // Service options included with this menu
  serviceOptions     Json     @default("{\"setup\": true, \"cleanup\": false, \"delivery\": true, \"staffService\": false, \"equipmentRental\": false}") @map("service_options")

  // Publication
  isPublished        Boolean  @default(false) @map("is_published")
  isActive           Boolean  @default(true) @map("is_active")
  isFeatured         Boolean  @default(false) @map("is_featured")

  // SEO
  metaTitle          String?  @map("meta_title") @db.VarChar(200)
  metaDescription    String?  @map("meta_description") @db.VarChar(500)

  createdAt          DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt          DateTime @default(now()) @map("updated_at") @db.Timestamptz(6)

  // Relations
  org                Organizations      @relation(fields: [orgId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  categories         CateringCategories[]
  items              CateringItems[]
  packages           CateringPackages[]
  eventDays          EventDays[]

  @@index([orgId], map: "idx_catering_menus_org_id")
  @@index([slug], map: "idx_catering_menus_slug")
  @@index([eventType], map: "idx_catering_menus_event_type")
  @@index([orgId, isPublished], map: "idx_catering_menus_org_published")
  @@index([orgId, isActive], map: "idx_catering_menus_org_active")
  @@map("catering_menus")
  @@schema("public")
}

/// Categories within a catering menu (e.g., Appetizers, Main Course, Desserts, Beverages)
model CateringCategories {
  id             String                 @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  cateringMenuId String                 @map("catering_menu_id") @db.Uuid
  name           String                 @db.VarChar(200)
  nameAr         String?                @map("name_ar") @db.VarChar(200)
  nameFr         String?                @map("name_fr") @db.VarChar(200)
  description    String?
  sortOrder      Int                    @default(0) @map("sort_order")
  isOptional     Boolean                @default(false) @map("is_optional")
  maxSelections  Int?                   @map("max_selections")
  createdAt      DateTime               @default(now()) @map("created_at") @db.Timestamptz(6)
  cateringMenu   CateringMenus          @relation(fields: [cateringMenuId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  cateringItems  CateringItems[]
  packageItems   CateringPackageItems[]

  @@index([cateringMenuId], map: "idx_catering_categories_menu_id")
  @@index([cateringMenuId, sortOrder], map: "idx_catering_categories_sort")
  @@map("catering_categories")
  @@schema("public")
}

/// Individual food/service items within a catering menu category
model CateringItems {
  id                 String                 @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  cateringCategoryId String                 @map("catering_category_id") @db.Uuid
  cateringMenuId     String                 @map("catering_menu_id") @db.Uuid
  name               String                 @db.VarChar(200)
  nameAr             String?                @map("name_ar") @db.VarChar(200)
  nameFr             String?                @map("name_fr") @db.VarChar(200)
  description        String?
  descriptionAr      String?                @map("description_ar")
  descriptionFr      String?                @map("description_fr")
  pricePerPerson     Int?                   @map("price_per_person")
  pricePerUnit       Int?                   @map("price_per_unit")
  unitLabel          String?                @map("unit_label") @db.VarChar(50)
  minQuantity        Int?                   @default(1) @map("min_quantity")
  servesCount        Int?                   @map("serves_count")
  isIncluded         Boolean                @default(true) @map("is_included")
  isOptional         Boolean                @default(false) @map("is_optional")

  // Dietary flags
  isVegetarian       Boolean                @default(false) @map("is_vegetarian")
  isVegan            Boolean                @default(false) @map("is_vegan")
  isHalal            Boolean                @default(true) @map("is_halal")
  isGlutenFree       Boolean                @default(false) @map("is_gluten_free")
  allergens          String[]               @default([])
  dietaryInfo        String?                @map("dietary_info")

  imageUrl           String?                @map("image_url")
  sortOrder          Int                    @default(0) @map("sort_order")
  isAvailable        Boolean                @default(true) @map("is_available")
  createdAt          DateTime               @default(now()) @map("created_at") @db.Timestamptz(6)
  category           CateringCategories     @relation(fields: [cateringCategoryId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  cateringMenu       CateringMenus          @relation(fields: [cateringMenuId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  packageItems       CateringPackageItems[]
  quoteItems         QuoteItems[]

  @@index([cateringCategoryId], map: "idx_catering_items_category_id")
  @@index([cateringMenuId], map: "idx_catering_items_menu_id")
  @@map("catering_items")
  @@schema("public")
}

/// Pre-built catering packages (e.g., "Gold Wedding Package", "Corporate Lunch")
model CateringPackages {
  id             String                 @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  cateringMenuId String                 @map("catering_menu_id") @db.Uuid
  name           String                 @db.VarChar(200)
  nameAr         String?                @map("name_ar") @db.VarChar(200)
  nameFr         String?                @map("name_fr") @db.VarChar(200)
  description    String?
  pricePerPerson Int                    @default(0) @map("price_per_person")
  minGuests      Int                    @default(10) @map("min_guests")
  maxGuests      Int?                   @map("max_guests")
  isFeatured     Boolean                @default(false) @map("is_featured")
  sortOrder      Int                    @default(0) @map("sort_order")
  imageUrl       String?                @map("image_url")
  includesText   String?                @map("includes_text")
  createdAt      DateTime               @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime               @default(now()) @map("updated_at") @db.Timestamptz(6)
  packageItems   CateringPackageItems[]
  cateringMenu   CateringMenus          @relation(fields: [cateringMenuId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([cateringMenuId], map: "idx_catering_packages_menu_id")
  @@index([cateringMenuId, sortOrder], map: "idx_catering_packages_sort")
  @@map("catering_packages")
  @@schema("public")
}

/// Many-to-many link between packages and items, with category context
model CateringPackageItems {
  id            String             @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  packageId     String             @map("package_id") @db.Uuid
  itemId        String             @map("item_id") @db.Uuid
  categoryId    String             @map("category_id") @db.Uuid
  isIncluded    Boolean            @default(true) @map("is_included")
  maxSelections Int?               @map("max_selections")
  category      CateringCategories @relation(fields: [categoryId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  item          CateringItems      @relation(fields: [itemId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  package       CateringPackages   @relation(fields: [packageId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([packageId, itemId])
  @@index([itemId], map: "idx_catering_package_items_item")
  @@index([packageId], map: "idx_catering_package_items_package")
  @@map("catering_package_items")
  @@schema("public")
}

// =============================================================================
// SECTION 5: Events (Full Lifecycle)
// =============================================================================

/// The core event entity representing the full lifecycle from inquiry to settlement.
/// Status follows a 12-state machine: inquiry -> reviewed -> quoted -> accepted ->
/// deposit_paid -> confirmed -> prep -> setup -> execution -> completed -> settled.
/// Plus: cancelled and declined as terminal/intermediate states.
model Events {
  id                   String        @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  orgId                String        @map("org_id") @db.Uuid
  clientId             String?       @map("client_id") @db.Uuid

  // Event details
  title                String?       @db.VarChar(300)
  description          String?
  eventType            EventType     @default(other) @map("event_type")
  eventDate            DateTime      @map("event_date") @db.Date
  eventEndDate         DateTime?     @map("event_end_date") @db.Date
  startTime            DateTime?     @map("start_time") @db.Time(6)
  endTime              DateTime?     @map("end_time") @db.Time(6)
  isMultiDay           Boolean       @default(false) @map("is_multi_day")

  // Venue
  venueName            String?       @map("venue_name") @db.VarChar(200)
  venueAddress         String?       @map("venue_address")
  venueCity            String?       @map("venue_city") @db.VarChar(100)
  venueLat             Float?        @map("venue_lat")
  venueLng             Float?        @map("venue_lng")

  // Guest management
  guestCount           Int           @map("guest_count")
  confirmedGuestCount  Int?          @map("confirmed_guest_count")
  dietaryRequirements  Json?         @default("[]") @map("dietary_requirements")

  // Inquiry source
  customerName         String        @map("customer_name") @db.VarChar(200)
  customerPhone        String        @map("customer_phone") @db.VarChar(30)
  customerEmail        String?       @map("customer_email") @db.VarChar(200)
  serviceStyle         String?       @map("service_style") @db.VarChar(50)
  budgetMin            Int?          @map("budget_min")
  budgetMax            Int?          @map("budget_max")
  specialRequests      String?       @map("special_requests")
  source               EventSource   @default(direct)

  // Status (12-state lifecycle)
  status               EventStatus   @default(inquiry)

  // Financial summary
  totalAmount          Int?          @default(0) @map("total_amount")
  depositAmount        Int?          @default(0) @map("deposit_amount")
  balanceDue           Int?          @default(0) @map("balance_due")

  // Notes
  notes                String?
  internalNotes        String?       @map("internal_notes")

  // Tracking
  lastMessageAt        DateTime?     @map("last_message_at") @db.Timestamptz(6)
  lastActivityAt       DateTime?     @default(now()) @map("last_activity_at") @db.Timestamptz(6)

  createdAt            DateTime      @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt            DateTime      @default(now()) @map("updated_at") @db.Timestamptz(6)

  // Relations
  org                  Organizations   @relation(fields: [orgId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  client               ClientProfiles? @relation(fields: [clientId], references: [id], onUpdate: NoAction)
  quotes               Quotes[]
  paymentSchedules     PaymentSchedules[]
  staffAssignments     StaffAssignments[]
  equipmentAllocations EquipmentAllocations[]
  conversations        Conversations[]
  reviews              Reviews[]
  invoices             Invoices[]
  eventDays            EventDays[]
  prepTasks            PrepTasks[]
  deliveryPlans        DeliveryPlans?

  @@index([orgId], map: "idx_events_org_id")
  @@index([clientId], map: "idx_events_client_id")
  @@index([eventDate], map: "idx_events_event_date")
  @@index([status], map: "idx_events_status")
  @@index([orgId, status], map: "idx_events_org_status")
  @@index([orgId, eventDate], map: "idx_events_org_date")
  @@index([orgId, status, eventDate], map: "idx_events_org_status_date")
  @@index([customerPhone], map: "idx_events_customer_phone")
  @@index([eventType], map: "idx_events_event_type")
  @@index([createdAt(sort: Desc)], map: "idx_events_created_at")
  @@map("events")
  @@schema("public")
}

/// Multi-day event support: each day can have different menus, venues, and guest counts.
/// E.g., "Day 1: Henna Night" with 100 guests, "Day 2: Wedding Ceremony" with 500 guests.
model EventDays {
  id         String        @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  eventId    String        @map("event_id") @db.Uuid
  dayDate    DateTime      @map("day_date") @db.Date
  dayLabel   String?       @map("day_label") @db.VarChar(200)
  startTime  DateTime?     @map("start_time") @db.Time(6)
  endTime    DateTime?     @map("end_time") @db.Time(6)
  guestCount Int?          @map("guest_count")
  venueName  String?       @map("venue_name") @db.VarChar(200)
  venueAddress String?     @map("venue_address")
  menuId     String?       @map("menu_id") @db.Uuid
  notes      String?
  sortOrder  Int           @default(0) @map("sort_order")
  createdAt  DateTime      @default(now()) @map("created_at") @db.Timestamptz(6)
  event      Events        @relation(fields: [eventId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  menu       CateringMenus? @relation(fields: [menuId], references: [id], onUpdate: NoAction)

  @@index([eventId], map: "idx_event_days_event_id")
  @@index([dayDate], map: "idx_event_days_date")
  @@map("event_days")
  @@schema("public")
}

// =============================================================================
// SECTION 6: Quotes (Versioned Proposals)
// =============================================================================

/// Versioned quote/proposal sent from caterer to client.
/// Multiple versions can exist for negotiation (v1, v2, v3...).
/// Contains full pricing breakdown with TVA, seasonal adjustments, and volume discounts.
model Quotes {
  id                  String        @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  eventId             String        @map("event_id") @db.Uuid
  orgId               String        @map("org_id") @db.Uuid
  versionNumber       Int           @default(1) @map("version_number")
  status              QuoteStatus   @default(draft)

  // Pricing summary (all amounts in centimes)
  subtotal            Int           @default(0)
  seasonalAdjustment  Int           @default(0) @map("seasonal_adjustment")
  volumeDiscount      Int           @default(0) @map("volume_discount")
  additionalCharges   Int           @default(0) @map("additional_charges")
  tvaRate             Decimal       @default(0) @map("tva_rate") @db.Decimal(5, 2)
  tvaAmount           Int           @default(0) @map("tva_amount")
  totalAmount         Int           @default(0) @map("total_amount")
  pricePerPerson      Int?          @map("price_per_person")

  // Terms
  validUntil          DateTime?     @map("valid_until") @db.Date
  cancellationPolicy  String?       @map("cancellation_policy")
  termsAndConditions  String?       @map("terms_and_conditions")
  notes               String?

  // PDF export
  pdfUrl              String?       @map("pdf_url")

  createdAt           DateTime      @default(now()) @map("created_at") @db.Timestamptz(6)
  sentAt              DateTime?     @map("sent_at") @db.Timestamptz(6)
  viewedAt            DateTime?     @map("viewed_at") @db.Timestamptz(6)
  respondedAt         DateTime?     @map("responded_at") @db.Timestamptz(6)
  expiredAt           DateTime?     @map("expired_at") @db.Timestamptz(6)

  // Relations
  event               Events        @relation(fields: [eventId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  org                 Organizations @relation(fields: [orgId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  items               QuoteItems[]

  @@index([eventId], map: "idx_quotes_event_id")
  @@index([orgId], map: "idx_quotes_org_id")
  @@index([status], map: "idx_quotes_status")
  @@index([eventId, versionNumber], map: "idx_quotes_event_version")
  @@map("quotes")
  @@schema("public")
}

/// Individual line items within a quote, organized into sections.
/// Sections: "Appetizers", "Main Course", "Setup Services", etc.
model QuoteItems {
  id              String         @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  quoteId         String         @map("quote_id") @db.Uuid
  sectionName     String         @map("section_name") @db.VarChar(200)
  sectionOrder    Int            @default(0) @map("section_order")
  itemName        String         @map("item_name") @db.VarChar(200)
  itemDescription String?        @map("item_description")
  quantity        Int            @default(1)
  unitType        UnitType       @default(per_person) @map("unit_type")
  unitPrice       Int            @map("unit_price")
  subtotal        Int
  itemOrder       Int            @default(0) @map("item_order")
  cateringItemId  String?        @map("catering_item_id") @db.Uuid
  cateringItem    CateringItems? @relation(fields: [cateringItemId], references: [id], onUpdate: NoAction)
  quote           Quotes         @relation(fields: [quoteId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([quoteId], map: "idx_quote_items_quote_id")
  @@map("quote_items")
  @@schema("public")
}

// =============================================================================
// SECTION 7: Payments (Milestone-Based)
// =============================================================================

/// Payment schedule for an event with cancellation policy.
/// Template-based: standard (30/50/20), half-half (50/50), full advance, corporate (NET 30).
model PaymentSchedules {
  id                     String              @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  eventId                String              @map("event_id") @db.Uuid
  orgId                  String              @map("org_id") @db.Uuid
  templateName           String?             @map("template_name") @db.VarChar(50)
  totalAmount            Int                 @map("total_amount")
  currency               String              @default("MAD") @db.VarChar(10)

  // Cancellation policy
  fullRefundDaysBefore   Int?                @default(30) @map("full_refund_days_before")
  partialRefundDaysBefore Int?               @default(14) @map("partial_refund_days_before")
  partialRefundPercent   Int?                @default(50) @map("partial_refund_percent")

  createdAt              DateTime            @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt              DateTime            @default(now()) @map("updated_at") @db.Timestamptz(6)

  // Relations
  event                  Events              @relation(fields: [eventId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  org                    Organizations       @relation(fields: [orgId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  milestones             PaymentMilestones[]

  @@index([eventId], map: "idx_payment_schedules_event_id")
  @@index([orgId], map: "idx_payment_schedules_org_id")
  @@map("payment_schedules")
  @@schema("public")
}

/// Individual payment milestones within a schedule (deposit, progress, final).
/// Tracks actual payment receipt with method, reference, and confirmation.
model PaymentMilestones {
  id               String           @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  scheduleId       String           @map("schedule_id") @db.Uuid
  label            String           @db.VarChar(100)
  milestoneType    MilestoneType    @default(deposit) @map("milestone_type")
  percentage       Decimal          @db.Decimal(5, 2)
  amount           Int
  dueDate          DateTime         @map("due_date") @db.Date
  status           PaymentStatus    @default(pending)
  paidAt           DateTime?        @map("paid_at") @db.Timestamptz(6)
  paymentMethod    PaymentMethod?   @map("payment_method")
  paymentReference String?          @map("payment_reference") @db.VarChar(200)
  receiptUrl       String?          @map("receipt_url")
  confirmedBy      String?          @map("confirmed_by") @db.Uuid
  notes            String?
  createdAt        DateTime         @default(now()) @map("created_at") @db.Timestamptz(6)
  schedule         PaymentSchedules @relation(fields: [scheduleId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([scheduleId], map: "idx_payment_milestones_schedule_id")
  @@index([status], map: "idx_payment_milestones_status")
  @@index([dueDate], map: "idx_payment_milestones_due_date")
  @@index([status, dueDate], map: "idx_payment_milestones_status_due")
  @@map("payment_milestones")
  @@schema("public")
}

// =============================================================================
// SECTION 8: Invoices (TVA-Compliant, PDF Export)
// =============================================================================

/// Moroccan-compliant invoice with ICE, RC, and TVA fields.
/// Can be exported as PDF for corporate clients requiring formal documentation.
model Invoices {
  id                  String        @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  invoiceNumber       String        @unique @map("invoice_number") @db.VarChar(50)
  eventId             String        @map("event_id") @db.Uuid
  orgId               String        @map("org_id") @db.Uuid

  // Client info (snapshot at invoice time)
  clientName          String        @map("client_name") @db.VarChar(200)
  clientPhone         String?       @map("client_phone") @db.VarChar(30)
  clientEmail         String?       @map("client_email") @db.VarChar(200)
  clientAddress       String?       @map("client_address")
  clientIce           String?       @map("client_ice") @db.VarChar(50)

  // Caterer info (snapshot at invoice time)
  orgBusinessName     String?       @map("org_business_name") @db.VarChar(200)
  orgIce              String?       @map("org_ice") @db.VarChar(50)
  orgRc               String?       @map("org_rc") @db.VarChar(50)
  orgAddress          String?       @map("org_address")

  // Amounts (centimes)
  subtotal            Int
  tvaRate             Decimal       @default(0) @map("tva_rate") @db.Decimal(5, 2)
  tvaAmount           Int           @default(0) @map("tva_amount")
  totalAmount         Int           @map("total_amount")
  amountPaid          Int           @default(0) @map("amount_paid")
  amountDue           Int           @map("amount_due")
  currency            String        @default("MAD") @db.VarChar(10)

  // Status
  status              InvoiceStatus @default(draft)
  issuedAt            DateTime?     @map("issued_at") @db.Timestamptz(6)
  dueDate             DateTime?     @map("due_date") @db.Date
  paidAt              DateTime?     @map("paid_at") @db.Timestamptz(6)
  paymentReference    String?       @map("payment_reference") @db.VarChar(200)

  // PDF
  pdfUrl              String?       @map("pdf_url")
  notes               String?

  createdAt           DateTime      @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt           DateTime      @default(now()) @map("updated_at") @db.Timestamptz(6)

  // Relations
  event               Events        @relation(fields: [eventId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  org                 Organizations @relation(fields: [orgId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  lineItems           InvoiceItems[]

  @@index([orgId], map: "idx_invoices_org_id")
  @@index([eventId], map: "idx_invoices_event_id")
  @@index([status], map: "idx_invoices_status")
  @@index([dueDate], map: "idx_invoices_due_date")
  @@index([orgId, status], map: "idx_invoices_org_status")
  @@map("invoices")
  @@schema("public")
}

/// Individual line items on an invoice
model InvoiceItems {
  id          String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  invoiceId   String   @map("invoice_id") @db.Uuid
  description String   @db.VarChar(500)
  quantity    Int      @default(1)
  unitPrice   Int      @map("unit_price")
  total       Int
  sortOrder   Int      @default(0) @map("sort_order")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  invoice     Invoices @relation(fields: [invoiceId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([invoiceId], map: "idx_invoice_items_invoice_id")
  @@map("invoice_items")
  @@schema("public")
}

// =============================================================================
// SECTION 9: Staff & Scheduling
// =============================================================================

/// External/freelance staff pool managed by the organization.
/// These are NOT org_members (who are platform users); these are field workers
/// who may not have app accounts (tracked by phone/name).
model CateringStaff {
  id                   String             @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  orgId                String             @map("org_id") @db.Uuid
  name                 String             @db.VarChar(200)
  phone                String?            @db.VarChar(30)
  role                 String             @db.VarChar(50)
  isFullTime           Boolean            @default(false) @map("is_full_time")
  hourlyRate           Int?               @map("hourly_rate")
  dailyRate            Int?               @map("daily_rate")
  skills               String[]           @default([])
  defaultAvailableDays String[]           @default([]) @map("default_available_days")
  blockedDates         DateTime[]         @default([]) @map("blocked_dates") @db.Date
  rating               Decimal?           @db.Decimal(3, 2)
  isActive             Boolean            @default(true) @map("is_active")
  createdAt            DateTime           @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt            DateTime           @default(now()) @map("updated_at") @db.Timestamptz(6)
  org                  Organizations      @relation(fields: [orgId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  staffAssignments     StaffAssignments[]

  @@index([orgId], map: "idx_catering_staff_org_id")
  @@index([orgId, isActive], map: "idx_catering_staff_org_active")
  @@index([orgId, role], map: "idx_catering_staff_org_role")
  @@map("catering_staff")
  @@schema("public")
}

/// Staff assignments linking either OrgMembers or CateringStaff to events.
/// Tracks role at event, shift times, pay, and attendance status.
model StaffAssignments {
  id            String          @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  eventId       String          @map("event_id") @db.Uuid
  orgMemberId   String?         @map("org_member_id") @db.Uuid
  staffId       String?         @map("staff_id") @db.Uuid
  roleAtEvent   String          @map("role_at_event") @db.VarChar(50)
  shiftStart    DateTime?       @map("shift_start") @db.Time(6)
  shiftEnd      DateTime?       @map("shift_end") @db.Time(6)
  tasks         String[]        @default([])
  status        StaffAssignmentStatus @default(assigned)
  payRate       Int?            @map("pay_rate")
  isPaid        Boolean         @default(false) @map("is_paid")
  notes         String?
  createdAt     DateTime        @default(now()) @map("created_at") @db.Timestamptz(6)
  event         Events          @relation(fields: [eventId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  orgMember     OrgMembers?     @relation(fields: [orgMemberId], references: [id], onUpdate: NoAction)
  staff         CateringStaff?  @relation(fields: [staffId], references: [id], onUpdate: NoAction)

  @@index([eventId], map: "idx_staff_assignments_event_id")
  @@index([orgMemberId], map: "idx_staff_assignments_org_member_id")
  @@index([staffId], map: "idx_staff_assignments_staff_id")
  @@index([eventId, status], map: "idx_staff_assignments_event_status")
  @@map("staff_assignments")
  @@schema("public")
}

// =============================================================================
// SECTION 10: Equipment Tracking
// =============================================================================

/// Equipment inventory owned by the organization (chafing dishes, tables, linens, etc.)
model Equipment {
  id                String                 @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  orgId             String                 @map("org_id") @db.Uuid
  name              String                 @db.VarChar(200)
  category          String                 @db.VarChar(50)
  quantityTotal     Int                    @default(1) @map("quantity_total")
  quantityAvailable Int                    @default(1) @map("quantity_available")
  condition         EquipmentCondition     @default(good)
  costPerUnit       Int?                   @map("cost_per_unit")
  rentalPricePerDay Int?                   @map("rental_price_per_day")
  imageUrl          String?                @map("image_url")
  notes             String?
  createdAt         DateTime               @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime               @default(now()) @map("updated_at") @db.Timestamptz(6)
  org               Organizations          @relation(fields: [orgId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  allocations       EquipmentAllocations[]

  @@index([orgId], map: "idx_equipment_org_id")
  @@index([orgId, category], map: "idx_equipment_org_category")
  @@map("equipment")
  @@schema("public")
}

/// Per-event equipment allocations with lifecycle tracking (reserved -> deployed -> returned)
model EquipmentAllocations {
  id                String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  equipmentId       String    @map("equipment_id") @db.Uuid
  eventId           String    @map("event_id") @db.Uuid
  quantityAllocated Int       @default(1) @map("quantity_allocated")
  quantityReturned  Int?      @default(0) @map("quantity_returned")
  pickupDate        DateTime? @map("pickup_date") @db.Date
  returnDate        DateTime? @map("return_date") @db.Date
  status            EquipmentAllocationStatus @default(reserved)
  deployedAt        DateTime? @map("deployed_at") @db.Timestamptz(6)
  returnedAt        DateTime? @map("returned_at") @db.Timestamptz(6)
  damageNotes       String?   @map("damage_notes")
  damageCost        Int?      @map("damage_cost")
  createdAt         DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  equipment         Equipment @relation(fields: [equipmentId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  event             Events    @relation(fields: [eventId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([eventId], map: "idx_equipment_allocations_event_id")
  @@index([equipmentId], map: "idx_equipment_allocations_equipment_id")
  @@index([status], map: "idx_equipment_allocations_status")
  @@map("equipment_allocations")
  @@schema("public")
}

// =============================================================================
// SECTION 11: Communication (Messaging)
// =============================================================================

/// Conversations between caterer and client, optionally linked to an event.
/// Uses Supabase Realtime for live messaging.
model Conversations {
  id              String        @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  eventId         String?       @map("event_id") @db.Uuid
  orgId           String        @map("org_id") @db.Uuid
  clientProfileId String?       @map("client_profile_id") @db.Uuid
  clientName      String?       @map("client_name") @db.VarChar(200)
  clientPhone     String?       @map("client_phone") @db.VarChar(30)
  lastMessageAt   DateTime?     @default(now()) @map("last_message_at") @db.Timestamptz(6)
  unreadOrg       Int           @default(0) @map("unread_org")
  unreadClient    Int           @default(0) @map("unread_client")
  status          String        @default("active") @db.VarChar(20)
  createdAt       DateTime      @default(now()) @map("created_at") @db.Timestamptz(6)
  event           Events?       @relation(fields: [eventId], references: [id], onUpdate: NoAction)
  org             Organizations @relation(fields: [orgId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  messages        Messages[]

  @@index([orgId], map: "idx_conversations_org_id")
  @@index([eventId], map: "idx_conversations_event_id")
  @@index([lastMessageAt(sort: Desc)], map: "idx_conversations_last_msg")
  @@index([orgId, status], map: "idx_conversations_org_status")
  @@map("conversations")
  @@schema("public")
}

/// Individual messages within a conversation.
/// Supports text, images, files, and system-generated messages (quote sent, payment received, etc.)
model Messages {
  id             String        @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  conversationId String        @map("conversation_id") @db.Uuid
  senderId       String?       @map("sender_id") @db.Uuid
  senderType     SenderType    @default(org_member) @map("sender_type")
  messageType    MessageType   @default(text) @map("message_type")
  content        String
  attachments    Json?         @default("[]") @db.JsonB
  metadata       Json?         @default("{}") @db.JsonB
  isRead         Boolean       @default(false) @map("is_read")
  readAt         DateTime?     @map("read_at") @db.Timestamptz(6)
  createdAt      DateTime      @default(now()) @map("created_at") @db.Timestamptz(6)
  conversation   Conversations @relation(fields: [conversationId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([conversationId], map: "idx_messages_conversation_id")
  @@index([conversationId, createdAt(sort: Desc)], map: "idx_messages_conversation_created")
  @@map("messages")
  @@schema("public")
}

// =============================================================================
// SECTION 12: Reviews (Multi-Dimensional)
// =============================================================================

/// Multi-dimensional reviews for completed events.
/// Tracks 7 rating dimensions: overall, food quality, presentation, service, punctuality, value, communication.
/// Supports verified reviews (linked to confirmed events on the platform).
model Reviews {
  id                   String        @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  orgId                String        @map("org_id") @db.Uuid
  eventId              String?       @map("event_id") @db.Uuid
  clientId             String?       @map("client_id") @db.Uuid
  reviewerName         String        @map("reviewer_name") @db.VarChar(200)
  reviewerPhone        String?       @map("reviewer_phone") @db.VarChar(30)
  eventType            String?       @map("event_type") @db.VarChar(50)
  guestCount           Int?          @map("guest_count")
  eventDate            DateTime?     @map("event_date") @db.Date

  // Multi-dimensional ratings (1-5)
  ratingOverall        Int           @map("rating_overall")
  ratingFoodQuality    Int?          @map("rating_food_quality")
  ratingPresentation   Int?          @map("rating_presentation")
  ratingServiceStaff   Int?          @map("rating_service_staff")
  ratingPunctuality    Int?          @map("rating_punctuality")
  ratingValueForMoney  Int?          @map("rating_value_for_money")
  ratingCommunication  Int?          @map("rating_communication")

  comment              String?
  photos               String[]      @default([])
  response             String?
  respondedAt          DateTime?     @map("responded_at") @db.Timestamptz(6)

  status               ReviewStatus  @default(pending)
  isVerified           Boolean       @default(false) @map("is_verified")
  isPublished          Boolean       @default(false) @map("is_published")
  isFeatured           Boolean       @default(false) @map("is_featured")

  createdAt            DateTime      @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt            DateTime      @default(now()) @map("updated_at") @db.Timestamptz(6)

  org                  Organizations @relation(fields: [orgId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  event                Events?       @relation(fields: [eventId], references: [id], onUpdate: NoAction)

  @@index([orgId], map: "idx_reviews_org_id")
  @@index([eventId], map: "idx_reviews_event_id")
  @@index([status], map: "idx_reviews_status")
  @@index([orgId, ratingOverall(sort: Desc)], map: "idx_reviews_org_rating")
  @@index([orgId, status, createdAt(sort: Desc)], map: "idx_reviews_org_status_created")
  @@map("reviews")
  @@schema("public")
}

// =============================================================================
// SECTION 13: Kitchen Prep & Delivery Planning
// =============================================================================

/// Prep timeline tasks for event preparation (shopping, prep, cooking, assembly, packing, setup).
/// Tasks can have dependencies (task B must complete before task C starts).
model PrepTasks {
  id             String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  eventId        String   @map("event_id") @db.Uuid
  name           String   @db.VarChar(200)
  category       String   @default("prep") @db.VarChar(50)
  assignedTo     String[] @default([]) @map("assigned_to")
  startTime      DateTime? @map("start_time") @db.Timestamptz(6)
  endTime        DateTime? @map("end_time") @db.Timestamptz(6)
  durationMinutes Int?    @map("duration_minutes")
  dependsOn      String[] @default([]) @map("depends_on")
  status         String   @default("pending") @db.VarChar(30)
  notes          String?
  sortOrder      Int      @default(0) @map("sort_order")
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  event          Events   @relation(fields: [eventId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([eventId], map: "idx_prep_tasks_event_id")
  @@index([eventId, status], map: "idx_prep_tasks_event_status")
  @@map("prep_tasks")
  @@schema("public")
}

/// Delivery/logistics plan for an event.
/// Tracks full timeline from kitchen loading to venue return.
/// One plan per event (1:1 relationship).
model DeliveryPlans {
  id                String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  eventId           String   @unique @map("event_id") @db.Uuid
  venueLat          Float?   @map("venue_lat")
  venueLng          Float?   @map("venue_lng")
  vehicleType       String?  @map("vehicle_type") @db.VarChar(30)
  driverName        String?  @map("driver_name") @db.VarChar(200)
  driverPhone       String?  @map("driver_phone") @db.VarChar(30)

  // Timeline
  loadingStartTime  DateTime? @map("loading_start_time") @db.Timestamptz(6)
  departureTime     DateTime? @map("departure_time") @db.Timestamptz(6)
  estimatedArrival  DateTime? @map("estimated_arrival") @db.Timestamptz(6)
  setupStartTime    DateTime? @map("setup_start_time") @db.Timestamptz(6)
  serviceStartTime  DateTime? @map("service_start_time") @db.Timestamptz(6)
  serviceEndTime    DateTime? @map("service_end_time") @db.Timestamptz(6)
  teardownEndTime   DateTime? @map("teardown_end_time") @db.Timestamptz(6)
  returnTime        DateTime? @map("return_time") @db.Timestamptz(6)

  // Manifests and checklists (JSON arrays)
  foodManifest       Json?    @default("[]") @map("food_manifest") @db.JsonB
  equipmentManifest  Json?    @default("[]") @map("equipment_manifest") @db.JsonB
  loadingChecklist   Json?    @default("[]") @map("loading_checklist") @db.JsonB
  setupChecklist     Json?    @default("[]") @map("setup_checklist") @db.JsonB
  teardownChecklist  Json?    @default("[]") @map("teardown_checklist") @db.JsonB

  notes             String?
  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime @default(now()) @map("updated_at") @db.Timestamptz(6)
  event             Events   @relation(fields: [eventId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@map("delivery_plans")
  @@schema("public")
}

// =============================================================================
// SECTION 14: Calendar & Availability
// =============================================================================

/// Blocked dates for an organization (vacations, holidays, maintenance).
/// Supports recurring blocks (e.g., every Friday) and one-time blocks.
model BlockedDates {
  id          String        @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  orgId       String        @map("org_id") @db.Uuid
  date        DateTime      @db.Date
  reason      String?       @db.VarChar(200)
  isRecurring Boolean       @default(false) @map("is_recurring")
  createdAt   DateTime      @default(now()) @map("created_at") @db.Timestamptz(6)
  org         Organizations @relation(fields: [orgId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([orgId], map: "idx_blocked_dates_org_id")
  @@index([orgId, date], map: "idx_blocked_dates_org_date")
  @@map("blocked_dates")
  @@schema("public")
}

// =============================================================================
// SECTION 15: Directory & Discovery
// =============================================================================

/// Geographic regions for directory organization (e.g., Grand Casablanca, Marrakech-Safi)
model Region {
  id        String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  name      String
  nameAr    String?  @map("name_ar")
  nameFr    String?  @map("name_fr")
  slug      String   @unique
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  sortOrder Int?     @default(0) @map("sort_order")
  cities    City[]

  @@index([name], map: "idx_regions_name")
  @@index([slug], map: "idx_regions_slug")
  @@map("regions")
  @@schema("public")
}

/// Cities within regions for caterer discovery and SEO pages
model City {
  id            String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  regionId      String   @map("region_id") @db.Uuid
  name          String
  nameAr        String?  @map("name_ar")
  nameFr        String?  @map("name_fr")
  slug          String   @unique
  description   String?
  descriptionAr String?  @map("description_ar")
  descriptionFr String?  @map("description_fr")
  imageUrl      String?  @map("image_url")
  latitude      Decimal? @db.Decimal(10, 7)
  longitude     Decimal? @db.Decimal(10, 7)
  population    Int?
  isFeatured    Boolean? @default(false) @map("is_featured")
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  region        Region   @relation(fields: [regionId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([regionId], map: "idx_cities_region_id")
  @@index([population(sort: Desc)], map: "idx_cities_population_desc")
  @@index([name(ops: raw("gin_trgm_ops"))], map: "idx_cities_name_trgm", type: Gin)
  @@index([population(sort: Desc)], map: "idx_cities_population")
  @@index([slug], map: "idx_cities_slug")
  @@map("cities")
  @@schema("public")
}

// =============================================================================
// SECTION 16: Analytics
// =============================================================================

/// Analytics events for tracking page views, interactions, and conversions.
/// Scoped to an organization for multi-tenant analytics.
model AnalyticsEvents {
  id        String        @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  orgId     String        @map("org_id") @db.Uuid
  eventType String        @map("event_type")
  eventData Json?         @default("{}") @map("event_data")
  sessionId String?       @map("session_id")
  userAgent String?       @map("user_agent")
  ipHash    String?       @map("ip_hash")
  referrer  String?
  createdAt DateTime      @default(now()) @map("created_at") @db.Timestamptz(6)
  org       Organizations @relation(fields: [orgId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([orgId], map: "idx_analytics_events_org_id")
  @@index([eventType], map: "idx_analytics_events_type")
  @@index([createdAt], map: "idx_analytics_events_created_at")
  @@index([sessionId], map: "idx_analytics_events_session")
  @@index([orgId, eventType, createdAt(sort: Desc)], map: "idx_analytics_org_type_created")
  @@index([orgId, createdAt(sort: Desc)], map: "idx_analytics_org_created")
  @@map("analytics_events")
  @@schema("public")
}

// =============================================================================
// SECTION 17: Push Notifications
// =============================================================================

/// Web Push subscription for browser push notifications.
/// Linked to user (not order, since this is a B2B tool).
model PushSubscriptions {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  endpoint  String
  p256dh    String
  auth      String
  createdAt DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)

  @@unique([userId, endpoint])
  @@index([userId], map: "idx_push_subscriptions_user_id")
  @@map("push_subscriptions")
  @@schema("public")
}

// =============================================================================
// ENUMS — Auth Schema
// =============================================================================

enum AalLevel {
  aal1
  aal2
  aal3

  @@map("aal_level")
  @@schema("auth")
}

enum CodeChallengeMethod {
  s256
  plain

  @@map("code_challenge_method")
  @@schema("auth")
}

enum FactorStatus {
  unverified
  verified

  @@map("factor_status")
  @@schema("auth")
}

enum FactorType {
  totp
  webauthn
  phone

  @@map("factor_type")
  @@schema("auth")
}

enum OauthAuthorizationStatus {
  pending
  approved
  denied
  expired

  @@map("oauth_authorization_status")
  @@schema("auth")
}

enum OauthClientType {
  public
  confidential

  @@map("oauth_client_type")
  @@schema("auth")
}

enum OauthRegistrationType {
  dynamic
  manual

  @@map("oauth_registration_type")
  @@schema("auth")
}

enum OauthResponseType {
  code

  @@map("oauth_response_type")
  @@schema("auth")
}

enum OneTimeTokenType {
  confirmation_token
  reauthentication_token
  recovery_token
  email_change_token_new
  email_change_token_current
  phone_change_token

  @@map("one_time_token_type")
  @@schema("auth")
}

// =============================================================================
// ENUMS — Public Schema
// =============================================================================

/// User roles for platform-level access (profiles table)
enum UserRole {
  super_admin
  admin
  user

  @@map("user_role")
  @@schema("public")
}

/// Organization types for multi-tenant categorization
enum OrgType {
  caterer
  restaurant
  hotel
  venue
  event_planner

  @@map("org_type")
  @@schema("public")
}

/// Organization member roles (hierarchical)
enum OrgRole {
  org_owner
  admin
  manager
  staff

  @@map("org_role")
  @@schema("public")
}

/// Price range classification for directory filtering
enum PriceRange {
  budget
  mid
  premium
  luxury

  @@map("price_range")
  @@schema("public")
}

/// Subscription tiers for org-level feature gating
enum SubscriptionTier {
  free
  pro
  enterprise

  @@map("subscription_tier")
  @@schema("public")
}

/// Catering menu pricing model
enum MenuType {
  per_head
  per_dish
  package
  custom

  @@map("menu_type")
  @@schema("public")
}

/// Full event lifecycle states (12-state machine + cancelled)
enum EventStatus {
  inquiry
  reviewed
  quoted
  accepted
  declined
  deposit_paid
  confirmed
  prep
  setup
  execution
  completed
  settled
  cancelled

  @@map("event_status")
  @@schema("public")
}

/// Event type classification (culturally specific for Morocco/MENA)
enum EventType {
  wedding
  corporate
  ramadan_iftar
  eid
  birthday
  conference
  funeral
  engagement
  henna
  graduation
  diffa
  other

  @@map("event_type")
  @@schema("public")
}

/// Source of inquiry/event for conversion tracking
enum EventSource {
  direct
  marketplace
  referral
  whatsapp
  phone
  walk_in
  social_media

  @@map("event_source")
  @@schema("public")
}

/// Quote lifecycle statuses
enum QuoteStatus {
  draft
  sent
  viewed
  accepted
  rejected
  expired
  superseded

  @@map("quote_status")
  @@schema("public")
}

/// Unit type for quote line items
enum UnitType {
  per_person
  per_unit
  flat

  @@map("unit_type")
  @@schema("public")
}

/// Payment milestone types
enum MilestoneType {
  deposit
  progress
  final
  full

  @@map("milestone_type")
  @@schema("public")
}

/// Payment milestone statuses
enum PaymentStatus {
  pending
  due
  paid
  overdue
  waived
  cancelled

  @@map("payment_status")
  @@schema("public")
}

/// Payment methods available in Morocco
enum PaymentMethod {
  cod
  bank_transfer
  cmi
  check
  mobile_money
  cash

  @@map("payment_method")
  @@schema("public")
}

/// Invoice lifecycle statuses
enum InvoiceStatus {
  draft
  sent
  partial
  paid
  overdue
  cancelled

  @@map("invoice_status")
  @@schema("public")
}

/// Staff assignment attendance tracking
enum StaffAssignmentStatus {
  assigned
  confirmed
  checked_in
  checked_out
  no_show

  @@map("staff_assignment_status")
  @@schema("public")
}

/// Equipment condition tracking
enum EquipmentCondition {
  new_condition @map("new")
  good
  fair
  needs_repair
  retired

  @@map("equipment_condition")
  @@schema("public")
}

/// Equipment allocation lifecycle
enum EquipmentAllocationStatus {
  reserved
  picked_up
  in_use
  returned
  damaged

  @@map("equipment_allocation_status")
  @@schema("public")
}

/// Review moderation statuses
enum ReviewStatus {
  pending
  approved
  rejected

  @@map("review_status")
  @@schema("public")
}

/// Message sender type for conversations
enum SenderType {
  org_member
  client
  system

  @@map("sender_type")
  @@schema("public")
}

/// Message content type
enum MessageType {
  text
  image
  file
  quote
  invoice
  system

  @@map("message_type")
  @@schema("public")
}
